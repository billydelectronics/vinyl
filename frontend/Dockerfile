# syntax=docker/dockerfile:1.7

############################
# 1) Install deps (for build)
############################
FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci --no-audit --no-fund

###################################
# 2) Build SvelteKit (adapter-node)
###################################
FROM node:20-alpine AS build
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
# Your package.json mentions:
#   "prebuild": "svelte-kit sync"
#   "build": "vite build"
# If you're actually using SvelteKit, prefer: "build": "svelte-kit build"
# Either way, run the build script:
RUN npm run build

############################
# 3) Runtime (node adapter)
############################
FROM node:20-alpine AS runtime
WORKDIR /app

ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=3000

# Only production deps required by the built server
COPY package*.json ./
RUN npm ci --omit=dev --no-audit --no-fund

# Copy adapter-node output
# (SvelteKit adapter-node outputs a /build folder with server/client assets)
COPY --from=build /app/build ./build

# Run as non-root
USER node

EXPOSE 3000

# Healthcheck: consider 2xx/3xx OK by checking that a response comes back
# and the socket is reachable (simple GET /).
HEALTHCHECK --interval=5s --timeout=3s --retries=30 --start-period=30s \
  CMD node -e "require('http').get(`http://127.0.0.1:${process.env.PORT}/`, r => process.exit(r.statusCode < 500 ? 0 : 1)).on('error',()=>process.exit(1))"

# Start the Node adapter server (generated by SvelteKit)
CMD ["node", "build/index.js"]